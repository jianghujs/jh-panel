#!/bin/bash
timestamp=$(date +%Y%m%d_%H%M%S)
# BACKUP_PATH 是在 控制面板 -> Xtrabackup -> mysql备份目录 设置的目录，不要在此文件修改
rm -rf $BACKUP_INC_PATH
mkdir -p $BACKUP_INC_PATH
LOG_DIR="/www/server/xtrabackup/logs"
if [ ! -d "$LOG_DIR" ];then
    mkdir -p $LOG_DIR
fi
xtrabackup --backup --slave-info --user=root  --port=33067 --password=123456 --target-dir=$BACKUP_INC_PATH --incremental-basedir=$BACKUP_BASE_PATH --apply-log-only &>> $LOG_DIR/backup_inc_$timestamp.log
if [ $? -eq 0 ] && [ -d "$BACKUP_INC_PATH/mysql" ];then
    echo "|- $timestamp 增量备份成功" >> /www/server/xtrabackup-inc/xtrabackup.log
else
    echo "|- $timestamp 增量备份失败" >> /www/server/xtrabackup-inc/xtrabackup.log
fi
python3 /www/server/jh-panel/scripts/clean.py $LOG_DIR/